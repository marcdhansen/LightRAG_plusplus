name: Feature Branch Setup

on:
  create:
    branches: [ 'feature/*', 'agent/*', 'task/*' ]

jobs:
  setup-guidance:
    name: Feature Branch Setup Guidance
    runs-on: ubuntu-latest
    if: github.event.ref_type == 'branch'

    steps:
    - uses: actions/checkout@v6

    - name: Extract feature name
      id: feature-extract
      run: |
        BRANCH_NAME="${{ github.ref_name }}"
        if [[ "$BRANCH_NAME" =~ ^(feature|agent|task)/(.+)$ ]]; then
          FEATURE_NAME="${BASH_REMATCH[2]}"
          echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ New feature branch detected: $FEATURE_NAME"
        else
          echo "Not a feature branch, skipping setup"
          exit 0
        fi

    - name: Check for existing artifacts
      id: artifact-check
      run: |
        FEATURE_NAME="${{ steps.feature-extract.outputs.feature_name }}"
        MISSING_COUNT=0
        
        if [[ ! -f "tests/${FEATURE_NAME}_tdd.py" ]]; then
          ((MISSING_COUNT++))
          echo "missing_tdd=true" >> $GITHUB_OUTPUT
        fi
        
        if [[ ! -f "tests/${FEATURE_NAME}_functional.py" ]]; then
          ((MISSING_COUNT++))
          echo "missing_functional=true" >> $GITHUB_OUTPUT
        fi
        
        if [[ ! -f "docs/${FEATURE_NAME}_analysis.md" ]]; then
          ((MISSING_COUNT++))
          echo "missing_docs=true" >> $GITHUB_OUTPUT
        fi
        
        echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Missing artifacts: $MISSING_COUNT"

    - name: Create Setup Issue (if artifacts missing)
      if: steps.artifact-check.outputs.missing_count > 0
      uses: actions/github-script@v7
      with:
        script: |
          const featureName = '${{ steps.feature-extract.outputs.feature_name }}';
          const missingCount = '${{ steps.artifact-check.outputs.missing_count }}';
          const missingTdd = '${{ steps.artifact-check.outputs.missing_tdd }}' === 'true';
          const missingFunctional = '${{ steps.artifact-check.outputs.missing_functional }}' === 'true';
          const missingDocs = '${{ steps.artifact-check.outputs.missing_docs }}' === 'true';
          
          let issueBody = `## ðŸš€ Feature Branch Setup: ${featureName}\n\n`;
          issueBody += `New feature branch \`${{ github.ref_name }}\` created! ðŸŽ‰\n\n`;
          issueBody += `### ðŸ“‹ Missing TDD Artifacts (${missingCount}/3)\n\n`;
          
          if (missingTdd) {
            issueBody += `- âŒ \`tests/${featureName}_tdd.py\` (Unit tests)\n`;
          }
          if (missingFunctional) {
            issueBody += `- âŒ \`tests/${featureName}_functional.py\` (Integration tests)\n`;
          }
          if (missingDocs) {
            issueBody += `- âŒ \`docs/${featureName}_analysis.md\` (Technical analysis)\n`;
          }
          
          issueBody += `\n### ðŸ› ï¸ Quick Setup Solutions\n\n`;
          issueBody += `**Option 1: Auto-generate templates**\n`;
          issueBody += `\`\`\`bash\n`;
          issueBody += `./scripts/create-tdd-artifacts.sh ${featureName}\n`;
          issueBody += `\`\`\`\n\n`;
          
          issueBody += `**Option 2: Run development check**\n`;
          issueBody += `\`\`\`bash\n`;
          issueBody += `./scripts/dev-start-check.sh\n`;
          issueBody += `\`\`\`\n\n`;
          
          issueBody += `**Option 3: Manual creation**\n`;
          issueBody += `1. Create the missing files listed above\n`;
          issueBody += `2. Follow the TDD test structure from other features\n`;
          issueBody += `3. Commit the artifacts before starting implementation\n\n`;
          
          issueBody += `### ðŸ“š Resources\n\n`;
          issueBody += `- [TDD Guidelines](.github/workflows/tdd-compliance.yml)\n`;
          issueBody += `- [Development Workflow](AGENTS.md)\n`;
          issueBody += `- [Project Roadmap](.agent/rules/ROADMAP.md)\n\n`;
          
          issueBody += `---\n`;
          issueBody += `*This issue was automatically created to help set up your feature branch for success!*`;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš€ Setup: ${featureName} feature branch`,
            body: issueBody,
            labels: ['setup', 'tdd', 'enhancement']
          });

    - name: Success comment (if all artifacts exist)
      if: steps.artifact-check.outputs.missing_count == 0
      uses: actions/github-script@v7
      with:
        script: |
          const feature = '${{ steps.feature-extract.outputs.feature_name }}';
          github.rest.issues.createComment({
            issue_number: context.issue.number || 1,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸŽ‰ **Excellent!** All TDD artifacts are already present for feature: \`${feature}\`\n\nâœ… Ready for development!\n\nUse \`./scripts/dev-start-check.sh\` to validate your setup before starting work.`
          }).catch(() => {
            // Comment creation might fail if no issue/PR exists, that's okay
            console.log('No issue/PR to comment on, but setup is complete!');
          });