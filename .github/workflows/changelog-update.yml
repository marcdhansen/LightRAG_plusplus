name: Automated Changelog Synthesis

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-changelog')"
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Extract Commit Info
        id: commit-info
        run: |
          MESSAGE=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)
          DATE=$(date +%Y-%m-%d)

          # Use multiline file syntax to safely handle special characters
          # This avoids command-line interpretation issues
          {
            echo "message<<EOF"
            echo "$MESSAGE"
            echo "EOF"
            echo "author=$AUTHOR"
            echo "date=$DATE"
          } >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          MESSAGE="${{ steps.commit-info.outputs.message }}"
          DATE="${{ steps.commit-info.outputs.date }}"
          AUTHOR="${{ steps.commit-info.outputs.author }}"

          # Prepare the new entry (Markdown format)
          # Use awk instead of sed to avoid flag interpretation issues
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Insert after the header line using awk (safer than sed)
          awk '
            NR == 2 { 
              print "## ['$DATE'] - $AUTHOR"
              print ""
              print "'"$MESSAGE"'"
              print ""
            }
            { print }
          ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

          echo "âœ… CHANGELOG.md updated"

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md [skip-changelog]" || echo "No changes to commit"
          git push
