name: Automated Changelog Synthesis

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-changelog')"
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check file size before processing
        id: size-check
        run: |
          if [ -f CHANGELOG.md ]; then
            SIZE=$(stat -c%s CHANGELOG.md 2>/dev/null || stat -f%z CHANGELOG.md 2>/dev/null)
            SIZE_MB=$((SIZE / 1024 / 1024))
            echo "CHANGELOG.md size: ${SIZE_MB}MB"
            if [ "$SIZE" -gt 1048576 ]; then
              echo "ERROR: CHANGELOG.md exceeds 1MB limit ($SIZE bytes)"
              echo "size_exceeded=true" >> $GITHUB_OUTPUT
              exit 1
            fi
            echo "size_exceeded=false" >> $GITHUB_OUTPUT
          else
            echo "size_exceeded=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate CHANGELOG.md format
        if: steps.size-check.outputs.size_exceeded == 'false' && hashFiles('CHANGELOG.md')
        id: validate-changelog
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "CHANGELOG.md does not exist, will create new file"
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "line_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          LINE_COUNT=$(wc -l < CHANGELOG.md)
          echo "CHANGELOG.md exists with $LINE_COUNT lines"
          echo "line_count=$LINE_COUNT" >> $GITHUB_OUTPUT

          FIRST_LINE=$(head -n 1 CHANGELOG.md)
          if [ "$FIRST_LINE" != "# Changelog" ]; then
            echo "ERROR: CHANGELOG.md does not start with '# Changelog'"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          CORRUPTED_COUNT=$(grep -c "^## \[\] - " CHANGELOG.md 2>/dev/null || echo "0")
          if [ "$CORRUPTED_COUNT" -gt 0 ]; then
            echo "WARNING: Found $CORRUPTED_COUNT corrupted entries in CHANGELOG.md"
            echo "valid=false" >> $GITHUB_OUTPUT
          else
            echo "valid=true" >> $GITHUB_OUTPUT
          fi

      - name: Repair CHANGELOG.md if corrupted
        if: steps.validate-changelog.outputs.valid == 'false' && hashFiles('CHANGELOG.md')
        run: |
          echo "Repairing CHANGELOG.md..."
          {
            echo "# Changelog"
            echo ""
          } > CHANGELOG_REPAIRED.md

          if [ -f CHANGELOG.md ]; then
            grep -E "^## \[20[0-9]{2}-[0-9]{2}-[0-9]{2}\]" CHANGELOG.md >> CHANGELOG_REPAIRED.md 2>/dev/null || true
            awk '/^## \[20[0-9]{2}-[0-9]{2}-[0-9]{2}\]/ {found=1} found {print}' CHANGELOG.md >> CHANGELOG_REPAIRED.md 2>/dev/null || true
          fi

          mv CHANGELOG_REPAIRED.md CHANGELOG.md
          echo "✅ CHANGELOG.md repaired"

      - name: Extract Commit Info
        id: commit-info
        run: |
          MESSAGE="${{ github.event.head_commit.message }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          DATE=$(date +%Y-%m-%d)

          if [ -z "$AUTHOR" ] || [ -z "$MESSAGE" ]; then
            echo "ERROR: Empty author or message detected. Author='$AUTHOR', Message='$MESSAGE'"
            echo "empty=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          if echo "$MESSAGE" | grep -q "skip-changelog"; then
            echo "Skipping changelog update - commit message contains skip-changelog"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          {
            echo "message<<EOF"
            echo "$MESSAGE"
            echo "EOF"
            echo "author=$AUTHOR"
            echo "date=$DATE"
            echo "empty=false"
            echo "skip=false"
          } >> $GITHUB_OUTPUT

      - name: Check if update needed
        id: check-update
        run: |
          if [ "${{ steps.commit-info.outputs.skip }}" == "true" ]; then
            echo "Skipping changelog update"
            echo "skip=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.commit-info.outputs.empty }}" == "true" ]; then
            echo "Skipping changelog update - empty author or message"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Proceeding with changelog update"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install gawk for validation
        if: steps.validate-changelog.outputs.valid == 'true' || !hashFiles('CHANGELOG.md')
        run: |
          sudo apt-get update && sudo apt-get install -y gawk || {
            echo "Warning: Could not install gawk, will try to use existing installation"
          }
          gawk --version || echo "Warning: gawk not available"

      - name: Update CHANGELOG.md
        if: steps.check-update.outputs.skip != 'true' && steps.size-check.outputs.size_exceeded == 'false'
        run: |
          MESSAGE="${{ steps.commit-info.outputs.message }}"
          DATE="${{ steps.commit-info.outputs.date }}"
          AUTHOR="${{ steps.commit-info.outputs.author }}"

          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          awk '
            /^# Changelog$/ && !inserted {
              print
              print "## [" DATE "] - " AUTHOR
              print ""
              print MESSAGE
              print ""
              inserted=1
              next
            }
            { print }
          ' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

          echo "✅ CHANGELOG.md updated"

      - name: Commit and Push Changes
        if: steps.check-update.outputs.skip != 'true' && steps.size-check.outputs.size_exceeded == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md [skip-changelog]" || echo "No changes to commit"
          git push
