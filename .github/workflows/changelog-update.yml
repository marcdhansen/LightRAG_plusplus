name: Automated Changelog Synthesis

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-changelog')"
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Extract Commit Info
        id: commit-info
        run: |
          MESSAGE=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)
          DATE=$(date +%Y-%m-%d)

          # Use multiline file syntax to safely handle special characters
          # This avoids command-line interpretation issues
          {
            echo "message<<EOF"
            echo "$MESSAGE"
            echo "EOF"
            echo "author=$AUTHOR"
            echo "date=$DATE"
          } >> $GITHUB_OUTPUT

      - name: Validate CHANGELOG.md exists and has proper format
        id: validate-changelog
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "CHANGELOG.md does not exist, will create new file"
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "line_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          LINE_COUNT=$(wc -l < CHANGELOG.md)
          echo "CHANGELOG.md exists with $LINE_COUNT lines"
          echo "line_count=$LINE_COUNT" >> $GITHUB_OUTPUT

          # Check if first line is "# Changelog"
          FIRST_LINE=$(head -n 1 CHANGELOG.md)
          if [ "$FIRST_LINE" != "# Changelog" ]; then
            echo "ERROR: CHANGELOG.md does not start with '# Changelog'"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check for corrupted entries (empty author pattern "## [] - ")
          CORRUPTED_COUNT=$(grep -c "^## \[\] - " CHANGELOG.md 2>/dev/null || echo "0")
          if [ "$CORRUPTED_COUNT" -gt 0 ]; then
            echo "WARNING: Found $CORRUPTED_COUNT corrupted entries in CHANGELOG.md"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Repair CHANGELOG.md if corrupted
        if: steps.validate-changelog.outputs.valid == 'false'
        run: |
          echo "Repairing CHANGELOG.md..."
          # Remove corrupted entries but keep header
          {
            echo "# Changelog"
            echo ""
          } > CHANGELOG_REPAIRED.md

          # Try to preserve valid entries (entries with actual dates)
          if [ -f CHANGELOG.md ]; then
            # Keep only entries with valid dates (e.g., ## [2026-02-12])
            grep -E "^## \[20[0-9]{2}-[0-9]{2}-[0-9]{2}\]" CHANGELOG.md >> CHANGELOG_REPAIRED.md 2>/dev/null || true
            # Also add the content between valid entries
            awk '/^## \[20[0-9]{2}-[0-9]{2}-[0-9]{2}\]/ {found=1} found {print}' CHANGELOG.md >> CHANGELOG_REPAIRED.md 2>/dev/null || true
          fi

          mv CHANGELOG_REPAIRED.md CHANGELOG.md
          echo "✅ CHANGELOG.md repaired"

      - name: Install gawk for validation
        if: steps.validate-changelog.outputs.valid == 'true'
        run: sudo apt-get update && sudo apt-get install -y gawk

      - name: Validate AWK Script Syntax
        if: steps.validate-changelog.outputs.valid == 'true'
        run: |
          # Extract the awk script for validation
          AWK_SCRIPT='
          NR == 2 { 
            print "## [" DATE "] - " AUTHOR
            print ""
            print MESSAGE
            print ""
          }
          { print }
          '
          
          # Test awk syntax with gawk --lint (will warn about portability issues)
          echo "Running gawk --lint to check AWK portability..."
          echo "$AWK_SCRIPT" | gawk --lint-no-ext -f - CHANGELOG.md 2>&1 || true
          
          # Also do a basic syntax check with awk -f /dev/null
          echo "Running basic syntax check..."
          echo "$AWK_SCRIPT" | awk -f - /dev/null 2>&1 && echo "✅ AWK syntax valid"

      - name: Update CHANGELOG.md
        run: |
          MESSAGE="${{ steps.commit-info.outputs.message }}"
          DATE="${{ steps.commit-info.outputs.date }}"
          AUTHOR="${{ steps.commit-info.outputs.author }}"

          # Prepare the new entry (Markdown format)
          # Use awk instead of sed to avoid flag interpretation issues
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Insert after the header line using awk (safer than sed)
          # Using proper awk variable handling - double quotes for shell vars
          awk "
            NR == 2 { 
              print \"## [\" DATE \"] - \" AUTHOR
              print \"\"
              print MESSAGE
              print \"\"
            }
            { print }
          " CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

          echo "✅ CHANGELOG.md updated"

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md [skip-changelog]" || echo "No changes to commit"
          git push
