name: Automated Changelog Synthesis

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-changelog')"
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Extract Commit Info
        id: commit-info
        run: |
          MESSAGE=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)
          DATE=$(date +%Y-%m-%d)

          # Use multiline file syntax to safely handle special characters
          # This avoids command-line interpretation issues
          {
            echo "message<<EOF"
            echo "$MESSAGE"
            echo "EOF"
            echo "author=$AUTHOR"
            echo "date=$DATE"
          } >> $GITHUB_OUTPUT

      - name: Install gawk for validation
        run: sudo apt-get update && sudo apt-get install -y gawk

      - name: Validate AWK Script Syntax
        run: |
          # Extract the awk script for validation
          AWK_SCRIPT='
          NR == 2 { 
            print "## [" DATE "] - " AUTHOR
            print ""
            print MESSAGE
            print ""
          }
          { print }
          '
          
          # Test awk syntax with gawk --lint (will warn about portability issues)
          echo "Running gawk --lint to check AWK portability..."
          echo "$AWK_SCRIPT" | gawk --lint-no-ext -f - CHANGELOG.md 2>&1 || true
          
          # Also do a basic syntax check with awk -f /dev/null
          echo "Running basic syntax check..."
          echo "$AWK_SCRIPT" | awk -f - /dev/null 2>&1 && echo "✅ AWK syntax valid"

      - name: Update CHANGELOG.md
        run: |
          MESSAGE="${{ steps.commit-info.outputs.message }}"
          DATE="${{ steps.commit-info.outputs.date }}"
          AUTHOR="${{ steps.commit-info.outputs.author }}"
          DATE="${{ steps.commit-info.outputs.date }}"
          AUTHOR="${{ steps.commit-info.outputs.author }}"

          # Prepare the new entry (Markdown format)
          # Use awk instead of sed to avoid flag interpretation issues
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Insert after the header line using awk (safer than sed)
          # Using proper awk variable handling - double quotes for shell vars
          awk "
            NR == 2 { 
              print \"## [\" DATE \"] - \" AUTHOR
              print \"\"
              print MESSAGE
              print \"\"
            }
            { print }
          " CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md

          echo "✅ CHANGELOG.md updated"

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md [skip-changelog]" || echo "No changes to commit"
          git push
