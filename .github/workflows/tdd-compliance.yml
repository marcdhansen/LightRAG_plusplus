name: TDD Compliance Validation

on:
  push:
    branches: [ main, dev, 'feature/*', 'agent/*', 'task/*' ]
  pull_request:
    branches: [ main, dev ]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write


jobs:
  tdd-compliance-check:
    name: TDD Compliance Validation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Full git history for timeline validation

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest jq
        # Install beads if available
        if command -v npm >/dev/null 2>&1; then
          npm install -g @beadsdev/beads || echo "Beads installation failed, continuing..."
        fi

    - name: Check for beads availability
      id: beads-check
      run: |
        if command -v bd >/dev/null 2>&1; then
          echo "beads_available=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Beads command available"
        else
          echo "beads_available=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Beads command not available, some checks will be skipped"
        fi

    - name: Extract feature context
      id: feature-context
      run: |
        # Detect feature name from branch or changes
        FEATURE_NAME=""
        BRANCH_NAME=""

        # Determine effective branch name
        if [[ "$GITHUB_EVENT_NAME" == "pull_request" ]]; then
          BRANCH_NAME="$GITHUB_HEAD_REF"
        else
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        fi

        echo "üåø Branch detected: $BRANCH_NAME"

        # Improved extraction logic - robustly handle nested paths and prefixes
        FEATURE_NAME=$(echo "$BRANCH_NAME" | sed 's/.*\///' | sed 's/^task-//' | sed 's/^feature-//' | sed 's/^agent-//')


        # Fallback from changed files ONLY if no feature detected and not on main
        if [[ -z "$FEATURE_NAME" && "$BRANCH_NAME" != "main" && "$BRANCH_NAME" != "master" ]]; then
          FEATURE_FILE=$(git diff --name-only HEAD~5..HEAD | grep -E '^(lightrag|src)/' | head -1 | sed 's/.*\///' | sed 's/\.[^.]*$//' || echo "")
          if [[ -n "$FEATURE_FILE" ]]; then
            FEATURE_NAME="$FEATURE_FILE"
            echo "üîç Detected potential feature from file diff: $FEATURE_NAME"
          fi
        fi

        # Set environment variables
        echo "FEATURE_NAME=$FEATURE_NAME" >> $GITHUB_ENV

        # Output for GitHub Actions
        echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT
        echo "feature_detected=$([ -n "$FEATURE_NAME" ] && echo true || echo false)" >> $GITHUB_OUTPUT

        echo "üéØ Final Feature context: ${FEATURE_NAME:-NONE}"


    - name: Validate Git Branch Usage
      run: |
        echo "üîç Checking git branch usage..."
        echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
        echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
        echo "GITHUB_REF: $GITHUB_REF"

        CURRENT_BRANCH=${GITHUB_REF#refs/heads/}
        echo "Current branch: $CURRENT_BRANCH"

        # Block development on main/master
        if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" ]]; then
          # Check if this is a context where pushes to main are allowed
          # (e.g., CI runs, PR merges, or specific automation)
          if [[ "$GITHUB_EVENT_NAME" == "pull_request" || "$GITHUB_ACTIONS" == "true" || "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            echo "‚úÖ Action on main branch is allowed in this context ($GITHUB_EVENT_NAME)"
          else
            echo "‚ùå ERROR: Direct push to main/master branch detected"
            echo "All development must happen on feature branches"
            exit 1
          fi
        else
          echo "‚úÖ Development on feature branch: $CURRENT_BRANCH"
        fi

    - name: Validate Beads Issue (if available)
      if: steps.beads-check.outputs.beads_available == 'true'
      run: |
        echo "üîó Checking beads issue compliance..."

        # Check if beads repository is initialized
        if [[ ! -d ".beads" ]]; then
          echo "‚ö†Ô∏è Not a beads-enabled repository"
        else
          echo "‚úÖ Beads repository detected"

          # List available issues
          ISSUE_COUNT=$(bd list --all 2>/dev/null | wc -l | tr -d ' ' || echo "0")
          echo "Available beads issues: $ISSUE_COUNT"

          if [[ $ISSUE_COUNT -eq 0 ]]; then
            echo "‚ùå ERROR: No beads issues found"
            echo "Required: Create beads issue before development"
            exit 1
          fi

          # Check for feature-specific issues if feature detected
          if [[ "${{ steps.feature-context.outputs.feature_detected }}" == "true" ]]; then
            FEATURE_NAME="${{ steps.feature-context.outputs.feature_name }}"
            MATCHING_ISSUES=$(bd list --all 2>/dev/null | grep -i "$FEATURE_NAME" | wc -l | tr -d ' ' || echo "0")

            if [[ $MATCHING_ISSUES -gt 0 ]]; then
              echo "‚úÖ Found $MATCHING_ISSUES beads issue(s) for feature: $FEATURE_NAME"
            else
              echo "‚ö†Ô∏è No specific beads issues found for feature: $FEATURE_NAME"
            fi
          fi
        fi

    - name: Validate TDD Artifacts
      run: |
        echo "üß™ Validating TDD artifacts..."

        FEATURE_NAME="${{ steps.feature-context.outputs.feature_name }}"

        if [[ "${{ steps.feature-context.outputs.feature_detected }}" != "true" ]]; then
          echo "‚ÑπÔ∏è No specific feature detected, skipping artifact validation"
          exit 0
        fi

        # Define required artifacts based on feature type
        MISSING_ARTIFACTS=()

        # Check for TDD test file
        if [[ ! -f "tests/${FEATURE_NAME}_tdd.py" ]]; then
          MISSING_ARTIFACTS+=("tests/${FEATURE_NAME}_tdd.py")
        fi

        # Check for functional test file
        if [[ ! -f "tests/${FEATURE_NAME}_functional.py" ]]; then
          MISSING_ARTIFACTS+=("tests/${FEATURE_NAME}_functional.py")
        fi

        # Check for documentation
        if [[ ! -f "docs/${FEATURE_NAME}_analysis.md" ]]; then
          MISSING_ARTIFACTS+=("docs/${FEATURE_NAME}_analysis.md")
        fi

        # Report results
        if [[ ${#MISSING_ARTIFACTS[@]} -eq 0 ]]; then
          echo "‚úÖ All TDD artifacts present for feature: $FEATURE_NAME"
        else
          echo "‚ùå ERROR: Missing TDD artifacts for feature: $FEATURE_NAME"
          for artifact in "${MISSING_ARTIFACTS[@]}"; do
            echo "  - $artifact"
          done
          echo ""
          echo "üõ†Ô∏è  SOLUTION: Auto-create missing artifacts"
          echo "Run locally: ./scripts/create-tdd-artifacts.sh $FEATURE_NAME"
          echo ""
          echo "üìã Manual creation steps:"
          echo "1. Create tests/${FEATURE_NAME}_tdd.py with unit tests"
          echo "2. Create tests/${FEATURE_NAME}_functional.py with integration tests"
          echo "3. Create docs/${FEATURE_NAME}_analysis.md with technical analysis"
          echo ""
          echo "üö® Required TDD artifacts must exist before implementation"
          echo "üí° Use: ./scripts/dev-start-check.sh to validate before committing"
          exit 1
        fi

    - name: Validate TDD Timeline
      run: |
        echo "üìÖ Validating TDD commit timeline..."

        # Check recent commits for TDD compliance
        COMMITS_SINCE_FEATURE=10
        if git rev-parse --verify HEAD~$COMMITS_SINCE_FEATURE >/dev/null 2>&1; then
          COMMITS=$(git log --oneline HEAD~$COMMITS_SINCE_FEATURE..HEAD)
        else
          COMMITS=$(git log --oneline)
        fi

        if [[ -z "$COMMITS" ]]; then
          echo "‚ÑπÔ∏è No commits to analyze"
          exit 0
        fi

        echo "Analyzing commits:"
        echo "$COMMITS"
        echo ""

        # Count different types of commits
        TEST_COMMITS=$(echo "$COMMITS" | grep -i "test\|tdd" | wc -l | tr -d ' ')
        IMPL_COMMITS=$(echo "$COMMITS" | grep -i "feat\|impl\|fix" | wc -l | tr -d ' ')
        DOCS_COMMITS=$(echo "$COMMITS" | grep -i "docs\|readme" | wc -l | tr -d ' ')
        REFS_COMMITS=$(echo "$COMMITS" | grep -i "lightrag-" | wc -l | tr -d ' ')

        echo "Commit analysis:"
        echo "  Test-related: $TEST_COMMITS"
        echo "  Implementation: $IMPL_COMMITS"
        echo "  Documentation: $DOCS_COMMITS"
        echo "  Beads references: $REFS_COMMITS"

        # Validate beads issue references
        if [[ $REFS_COMMITS -eq 0 && $IMPL_COMMITS -gt 0 ]]; then
          echo "‚ö†Ô∏è WARNING: Implementation commits without beads issue references"
          echo "Consider referencing beads issues in commit messages"
        fi

        # Check test-first pattern (simplified)
        if [[ $TEST_COMMITS -gt 0 && $IMPL_COMMITS -gt 0 ]]; then
          echo "‚úÖ Both test and implementation commits found"
        elif [[ $IMPL_COMMITS -gt 0 ]]; then
          echo "‚ö†Ô∏è WARNING: Implementation without clear test commits"
        fi

    - name: Validate Test Structure (if TDD files exist)
      run: |
        echo "üî¨ Validating test structure..."

        FEATURE_NAME="${{ steps.feature-context.outputs.feature_name }}"
        TDD_FILE="tests/${FEATURE_NAME}_tdd.py"

        if [[ -f "$TDD_FILE" ]]; then
          echo "Analyzing TDD test file: $TDD_FILE"

          # Check for test functions
          TEST_COUNT=$(grep -c "def test_" "$TDD_FILE" || echo "0")
          ASSERTION_COUNT=$(grep -c "assert" "$TDD_FILE" || echo "0")

          echo "  Test functions: $TEST_COUNT"
          echo "  Assertions: $ASSERTION_COUNT"

          if [[ $TEST_COUNT -eq 0 ]]; then
            echo "‚ùå ERROR: TDD test file contains no test functions"
            exit 1
          fi

          if [[ $ASSERTION_COUNT -eq 0 ]]; then
            echo "‚ö†Ô∏è WARNING: TDD test file contains no assertions"
          fi

          echo "‚úÖ TDD test structure validated"
        else
          echo "‚ÑπÔ∏è No TDD test file found, skipping structure validation"
        fi

    - name: Generate TDD Compliance Report
      if: always()
      run: |
        echo "üìä Generating TDD compliance report..."

        REPORT_DIR="tdd-reports"
        mkdir -p "$REPORT_DIR"

        REPORT_FILE="$REPORT_DIR/tdd-compliance-${{ github.run_number }}.md"

        cat > "$REPORT_FILE" << EOF
        # TDD Compliance Report

        **Run ID:** ${{ github.run_id }}
        **Branch:** ${{ github.ref_name }}
        **Commit:** ${{ github.sha }}
        **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

        ## Summary

        - **Feature Detected:** ${{ steps.feature-context.outputs.feature_name || 'None' }}
        - **Beads Available:** ${{ steps.beads-check.outputs.beads_available }}
        - **TDD Artifacts Validated:** ${{ job.status }}

        ## Validation Results

        ### Git Branch Usage
        - Branch: \`${{ github.ref_name }}\`
        - Status: $([ "${{ github.ref_name }}" != "main" ] && echo "‚úÖ Feature branch" || echo "‚ö†Ô∏è Main branch")

        ### TDD Artifacts
        - Feature: \`${{ steps.feature-context.outputs.feature_name }}\`
        - Status: $([ "${{ job.status }}" == "success" ] && echo "‚úÖ Complete" || echo "‚ùå Missing artifacts")

        ### Timeline Analysis
        - Recent commits analyzed
        - Status: ‚úÖ Analyzed

        ## Recommendations

        $([ "${{ job.status }}" != "success" ] && echo "‚ö†Ô∏è Fix TDD compliance issues before merging")
        $([ "${{ steps.beads-check.outputs.beads_available }}" == "false" ] && echo "üí° Consider installing beads for better task tracking")

        ---
        *Generated by TDD Compliance Validation*
        EOF

        echo "üìÑ Report generated: $REPORT_FILE"

        # Upload as artifact
        echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT

    - name: Upload TDD Compliance Report
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: tdd-compliance-report-${{ github.run_number }}
        path: tdd-reports/
        retention-days: 30

    - name: Comment PR with TDD Status (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = './tdd-reports/tdd-compliance-' + context.runNumber + '.md';

          let commentBody = '## üß™ TDD Compliance Validation\n\n';

          if (process.env.JOB_STATUS === 'success') {
            commentBody += '‚úÖ **TDD Compliance Passed**\n\n';
          } else {
            commentBody += '‚ùå **TDD Compliance Failed**\n\n';
            commentBody += 'Please fix the TDD compliance issues before merging.\n\n';
          }

          // Try to read report
          try {
            const reportContent = fs.readFileSync(path, 'utf8');
            commentBody += reportContent;
          } catch (error) {
            commentBody += 'Report generation failed.\n';
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

  tdd-gate-enforcement:
    name: TDD Gate Enforcement
    runs-on: ubuntu-latest
    needs: tdd-compliance-check
    if: github.event_name == 'pull_request'

    steps:
    - name: Enforce TDD Gates
      run: |
        echo "üö™ Enforcing TDD quality gates..."

        if [[ "${{ needs.tdd-compliance-check.result }}" == "success" ]]; then
          echo "‚úÖ TDD compliance validation passed"
          echo "‚úÖ Ready for merge consideration"
        else
          echo "‚ùå TDD compliance validation failed"
          echo "‚ùå Merge blocked until TDD issues are resolved"
          exit 1
        fi
