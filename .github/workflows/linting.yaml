name: Linting and Formatting

on:
    push:
        branches:
            - main
            - dev
    pull_request:
        branches:
            - main
            - dev

jobs:
    lint-and-format:
        name: Linting and Formatting
        runs-on: ubuntu-latest

        strategy:
            matrix:
                python-version: ['3.12']

        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                fetch-depth: 0  # Full history for TDD validation

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v6
              with:
                python-version: ${{ matrix.python-version }}
                cache: 'pip'

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '20'

            - name: Set up Bun
              uses: oven-sh/setup-bun@v2
              with:
                bun-version: latest

            - name: Install uv (Python package manager)
              run: |
                curl -LsSf https://astral.sh/uv/install.sh | sh
                echo "$HOME/.cargo/bin" >> $GITHUB_PATH
              shell: bash

            - name: Install Python dependencies
              run: |
                python -m pip install --upgrade pip
                pip install pre-commit ruff pytest pytest-asyncio coverage
                # Install project in development mode
                pip install -e ".[api,test]"

            - name: Install WebUI dependencies (if exists)
              run: |
                if [[ -d "lightrag_webui" ]]; then
                  echo "üì¶ Installing WebUI dependencies..."
                  cd lightrag_webui && bun install --frozen-lockfile
                else
                  echo "‚ÑπÔ∏è WebUI directory not found, skipping WebUI dependencies"
                fi
              shell: bash

            - name: Cache pre-commit environment
              uses: actions/cache@v4
              with:
                path: ~/.cache/pre-commit
                key: ${{ runner.os }}-pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
                restore-keys: |
                  ${{ runner.os }}-pre-commit-

            - name: Install pre-commit hooks
              run: |
                pre-commit install --hook-types pre-commit,pre-push,commit-msg 2>/dev/null || echo "pre-commit install failed, continuing..."
              continue-on-error: true

            - name: Run pre-commit checks
              run: |
                echo "üîç Running pre-commit checks..."
                # Run pre-commit with timeout and better error handling
                timeout 300 pre-commit run --all-files --show-diff-on-failure || {
                  echo "‚ùå Pre-commit checks failed or timed out"
                  echo "üîß Common fixes:"
                  echo "  ‚Ä¢ Check that all required dependencies are installed"
                  echo "  ‚Ä¢ Ensure proper Python version (3.12+)"
                  echo "  ‚Ä¢ Verify file permissions are correct"
                  echo "  ‚Ä¢ Run 'pre-commit clean' if cache issues persist"
                  exit 1
                }
              shell: bash
              continue-on-error: false

            - name: Verify linting results
              run: |
                echo "‚úÖ Linting completed successfully!"
                echo "üìä Summary of checks performed:"
                echo "  ‚Ä¢ Ruff linting and formatting"
                echo "  ‚Ä¢ Pre-commit hooks validation"
                echo "  ‚Ä¢ TDD compliance checks"
                echo "  ‚Ä¢ Documentation coverage"
                echo "  ‚Ä¢ WebUI linting (if applicable)"
              shell: bash
