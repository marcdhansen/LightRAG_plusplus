name: Hotfix Pipeline

on:
  push:
    branches:
      - 'hotfix/**'
  pull_request:
    branches:
      - 'hotfix/**'
  workflow_dispatch:
    inputs:
      hotfix-id:
        description: 'Hotfix ID (e.g., hotfix-123)'
        required: false

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.12'

jobs:
  detect-hotfix:
    runs-on: ubuntu-latest
    outputs:
      hotfix-id: ${{ steps.detect.outputs.hotfix-id }}
      description: ${{ steps.detect.outputs.description }}
    steps:
      - uses: actions/checkout@v6

      - name: Detect Hotfix ID
        id: detect
        run: |
          HOTFIX_ID=""
          DESCRIPTION="Emergency hotfix"

          # From workflow dispatch
          if [[ "${{ github.event.inputs.hotfix-id }}" != "" ]]; then
            HOTFIX_ID="${{ github.event.inputs.hotfix-id }}"
          # From branch name
          elif [[ "${{ github.ref_name }}" == hotfix/* ]]; then
            HOTFIX_ID="${{ github.ref_name }}"
          fi

          # Try to extract from latest commit message
          if [[ -z "$HOTFIX_ID" ]]; then
            COMMIT_MSG=$(git log -1 --format="%s")
            HOTFIX_ID=$(echo "$COMMIT_MSG" | grep -oE 'hotfix-[a-zA-Z0-9]+' | head -1)
          fi

          # Default if still empty
          if [[ -z "$HOTFIX_ID" ]]; then
            HOTFIX_ID="hotfix-$(date +%Y%m%d-%H%M%S)"
          fi

          echo "hotfix-id=$HOTFIX_ID" >> $GITHUB_OUTPUT
          echo "description=Hotfix: $HOTFIX_ID" >> $GITHUB_OUTPUT
          echo "Detected hotfix: $HOTFIX_ID"

  create-beads-issue:
    runs-on: ubuntu-latest
    needs: detect-hotfix
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Create Beads Issue for Hotfix
        run: |
          HOTFIX_ID="${{ needs.detect-hotfix.outputs.hotfix-id }}"
          echo "Creating beads issue for $HOTFIX_ID"

          # Check if bd is available
          if ! command -v bd &> /dev/null; then
            echo "bd not available - skipping issue creation"
            exit 0
          fi

          # Create issue (would need proper setup)
          # bd create "Hotfix: $HOTFIX_ID" --priority 0 --type bug --labels "hotfix,emergency"
          echo "Would create issue: Hotfix: $HOTFIX_ID"

  setup-environment:
    runs-on: ubuntu-latest
    needs: detect-hotfix
    outputs:
      cache-key: ${{ steps.cache.outputs.cache-key }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        id: cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/.github/workflows/hotfix-pipeline.yml') }}-v1
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set cache key output
        run: echo "cache-key=${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/.github/workflows/hotfix-pipeline.yml') }}-v1" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test,api]"
          pip install "langgraph>=1.0.0" "langgraph-checkpoint>=4.0.0" "langgraph-checkpoint-sqlite>=3.0.0"
          pip install pytest-cov>=4.0.0 coverage[toml]

  unit-tests:
    runs-on: ubuntu-latest
    needs: [detect-hotfix, setup-environment]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Restore pip cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/.github/workflows/hotfix-pipeline.yml') }}-v1
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test,api]"
          pip install "langgraph>=1.0.0" "langgraph-checkpoint>=4.0.0" "langgraph-checkpoint-sqlite>=3.0.0"
          pip install pytest-cov>=4.0.0 coverage[toml]

      - name: Run Unit Tests
        run: |
          python -m pytest tests/ \
            -m "offline and not integration" \
            --ignore=tests/ui \
            --tb=short \
            --junitxml=test-results.xml \
            --cov=lightrag \
            --cov-report=xml \
            --cov-report=json \
            --cov-fail-under=10

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: hotfix-unit-test-results
          path: test-results.xml
          retention-days: 7
          if-no-files-found: warn

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: hotfix-coverage-reports
          path: |
            coverage.xml
            coverage.json
          retention-days: 30
          if-no-files-found: warn

  integration-tests:
    runs-on: ubuntu-latest
    needs: [detect-hotfix, setup-environment]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Restore pip cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/.github/workflows/hotfix-pipeline.yml') }}-v1
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test,api]"

      - name: Run Integration Tests
        run: |
          pip install pytest-timeout
          pytest tests/ -m integration --ignore=tests/ui --timeout=600
        continue-on-error: true

  auto-merge:
    runs-on: ubuntu-latest
    needs: [detect-hotfix, unit-tests, integration-tests]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix/')
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v6

      - name: Check if tests passed
        run: |
          echo "Unit tests: ${{ needs.unit-tests.result }}"
          echo "Integration tests: ${{ needs.integration-tests.result }}"

          if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
            echo "✅ All tests passed - ready for merge"
          else
            echo "❌ Tests failed - merge blocked"
            exit 1
          fi

      - name: Check if branch is up-to-date or already merged
        id: check-branch
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Check if branch is already merged into main
          MERGED=$(gh pr view "$BRANCH_NAME" --json state 2>/dev/null || echo "not_found")
          if [[ "$MERGED" == "MERGED" ]]; then
            echo "status=already_merged" >> $GITHUB_OUTPUT
            echo "Branch $BRANCH_NAME is already merged"
            exit 0
          fi
          
          # Check if branch is up-to-date with main (no commits behind)
          BEHIND=$(gh api repos/${{ github.repository }}/compare/main...$BRANCH_NAME --jq '.behind_by' 2>/dev/null || echo "1")
          if [[ "$BEHIND" == "0" ]]; then
            echo "status=up_to_date" >> $GITHUB_OUTPUT
            echo "Branch $BRANCH_NAME is already up-to-date with main"
            exit 0
          fi
          
          echo "status=needs_merge" >> $GITHUB_OUTPUT
          echo "Branch $BRANCH_NAME needs merge ($BEHIND commits behind)"

      - name: Create PR for Hotfix
        id: create-pr
        if: steps.check-branch.outputs.status == 'needs_merge'
        run: |
          HOTFIX_ID="${{ needs.detect-hotfix.outputs.hotfix-id }}"
          BRANCH_NAME="${{ github.ref_name }}"

          # Check if PR already exists
          PR_NUMBER=$(gh pr list --base main --head "$BRANCH_NAME" --json number -q '.[0].number // empty' 2>/dev/null || echo "")

          if [[ -z "$PR_NUMBER" ]]; then
            printf '%s\n' \
              "## Hotfix Summary" \
              "" \
              "**ID:** $HOTFIX_ID" \
              "**Trigger:** ${{ github.event_name }}" \
              "" \
              "### Status" \
              "- Unit tests: PASSED" \
              "- Integration tests: PASSED" \
              "" \
              "### Review Required" \
              "This hotfix requires review within 24 hours of merge." > /tmp/pr_body.md

            gh pr create --base main --head "$BRANCH_NAME" \
              --title "HOTFIX: $HOTFIX_ID" \
              --body-file /tmp/pr_body.md

            echo "PR created for hotfix merge"
            PR_NUMBER=$(gh pr list --base main --head "$BRANCH_NAME" --json number -q '.[0].number')
          else
            echo "PR already exists for this branch: #$PR_NUMBER"
          fi
          echo "pull-request-number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Auto-merge PR
        if: steps.check-branch.outputs.status == 'needs_merge'
        run: |
          PR_NUM="${{ steps.create-pr.outputs.pull-request-number }}"
          if [[ -n "$PR_NUM" ]]; then
            sleep 5
            # Try to merge, but handle gracefully if already merged or nothing to merge
            if gh pr merge --auto --squash "$PR_NUM" 2>&1; then
              echo "✅ Successfully merged PR #$PR_NUM"
            else
              # Check if it's already merged
              STATE=$(gh pr view "$PR_NUM" --json state -q '.state' 2>/dev/null || echo "unknown")
              if [[ "$STATE" == "MERGED" ]]; then
                echo "ℹ️ PR #$PR_NUM was already merged"
              else
                echo "⚠️ Auto-merge not enabled - manual merge may be required"
              fi
            fi
          fi

      - name: Post-Merge Actions
        run: |
          HOTFIX_ID="${{ needs.detect-hotfix.outputs.hotfix-id }}"
          BRANCH_NAME="${{ github.ref_name }}"
          STATUS="${{ steps.check-branch.outputs.status }}"
          
          echo "## Hotfix Complete: $HOTFIX_ID"
          echo "- Branch: $BRANCH_NAME"
          
          if [[ "$STATUS" == "already_merged" ]]; then
            echo "- Status: ℹ️ Already merged to main"
          elif [[ "$STATUS" == "up_to_date" ]]; then
            echo "- Status: ℹ️ Already up-to-date with main"
          else
            echo "- Status: ✅ Merged to main"
          fi
          echo ""
          echo "⚠️ Review required within 24 hours"

  notify:
    runs-on: ubuntu-latest
    needs: [detect-hotfix, unit-tests, integration-tests, auto-merge]
    if: always()
    steps:
      - name: Notify on Failure
        if: needs.auto-merge.result == 'failure'
        run: |
          echo "❌ Hotfix pipeline failed"
          echo "Hotfix: ${{ needs.detect-hotfix.outputs.hotfix-id }}"
          echo "Unit tests: ${{ needs.unit-tests.result }}"
          echo "Integration tests: ${{ needs.integration-tests.result }}"

      - name: Notify on Success
        if: needs.auto-merge.result == 'success'
        run: |
          echo "✅ Hotfix merged successfully"
          echo "Hotfix: ${{ needs.detect-hotfix.outputs.hotfix-id }}"
