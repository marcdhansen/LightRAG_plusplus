name: Offline Unit Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  offline-tests:
    name: Offline Tests
    runs-on: ubuntu-latest

    # Add timeout for the entire job
    timeout-minutes: 30

    strategy:
      matrix:
        python-version: ['3.12']
      fail-fast: false

    steps:
    - uses: actions/checkout@v6
      with:
        # Add retry for checkout
        fetch-depth: 0
        persist-credentials: false

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Verify Python Setup
      run: |
        python --version && python -c "import sys; print(f'Python {sys.version} setup successful')"

    - name: Cache pip packages
      uses: actions/cache@v5
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/.github/workflows/tests.yml') }}-v2
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Handle Network Failures Gracefully
      run: |
        echo "üåê Configuring network resilience..."
        # Set longer timeouts for pip operations
        pip config set global.timeout 600
        # Configure retries for network operations
        pip config set global.retries 3

    - name: Install dependencies
      run: |
        echo "üì¶ Installing dependencies with enhanced error handling..."
        python -m pip install --upgrade pip setuptools wheel
        pip install -e ".[test,api]" --verbose
        # Ensure langgraph checkpoint dependencies are explicitly installed
        pip install "langgraph>=1.0.0" "langgraph-checkpoint>=4.0.0" "langgraph-checkpoint-sqlite>=3.0.0"
        # Ensure coverage and test dependencies are available
        pip install pytest-cov>=4.0.0 pytest-xdist coverage[toml]
        echo "‚úÖ Dependencies installed successfully"

    - name: Verify Test Discovery
      run: |
        echo "üîç Verifying test discovery before execution..."
        python -m pytest tests/ --collect-only -m offline --ignore=tests/ui -q
        echo "‚úÖ Test discovery completed successfully"

    - name: Run offline tests
      run: |
        echo "üß™ Running offline tests with enhanced configuration..."
        python -m pytest tests/ \
          -m offline \
          --ignore=tests/ui \
          -v \
          --tb=short \
          --junitxml=test-results.xml \
          --cov=lightrag \
          --cov-report=xml \
          --cov-report=json \
          --cov-report=html \
          --cov-fail-under=10

    - name: Verify Coverage Files
      run: |
        echo "üîç Verifying coverage files were generated..."
        ls -la coverage.xml coverage.json || {
          echo "‚ùå Coverage files missing"
          exit 1
        }
        echo "‚úÖ Coverage files verified"

    - name: Upload test results
      if: always() && (hashFiles('test-results.xml') != '')
      uses: actions/upload-artifact@v6
      with:
        name: test-results-py${{ matrix.python-version }}
        path: |
          test-results.xml
          .pytest_cache/
        retention-days: 7
        if-no-files-found: warn

    - name: Upload coverage artifacts
      if: always() && (hashFiles('coverage.xml') != '' || hashFiles('coverage.json') != '')
      uses: actions/upload-artifact@v6
      with:
        name: coverage-reports-py${{ matrix.python-version }}
        path: |
          coverage.xml
          coverage.json
          htmlcov/
        retention-days: 30
        if-no-files-found: warn

    - name: Handle CI failure and create issue
      if: failure()
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üö® Tests failed - starting GitHub issue creation process..."
        echo "üîç Checking GitHub CLI authentication..."

        if ! gh auth status > /dev/null 2>&1; then
          echo "‚ùå GitHub CLI authentication failed"
          exit 1
        fi

        echo "‚úÖ GitHub CLI authenticated successfully"

        # Set environment variables for diagnostic script
        export GITHUB_ACTIONS=true
        export WORKFLOW_NAME="Offline Unit Tests"
        export RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        export GITHUB_REPOSITORY="${{ github.repository }}"
        export GITHUB_REF_NAME="${{ github.ref_name }}"
        export GITHUB_SHA="${{ github.sha }}"
        export GH_TOKEN="${{ github.token }}"

        echo "üß™ Running diagnostic script with CI environment..."
        echo "üìä Environment:"
        echo "  - Workflow: $WORKFLOW_NAME"
        echo "  - Run URL: $RUN_URL"
        echo "  - Branch: $GITHUB_REF_NAME"
        echo "  - Commit: $GITHUB_SHA"
        echo "  - Repository: $GITHUB_REPOSITORY"

        # Run diagnostic script (will create issue if tests fail)
        if ./scripts/ci-diagnostic.sh; then
          echo "‚úÖ Diagnostic script completed successfully"
        else
          echo "‚ö†Ô∏è Diagnostic script failed, creating basic fallback issue..."

          # Create basic issue as fallback
          ISSUE_TITLE="CI failed: Offline Unit Tests"
          ISSUE_BODY="## üö® CI/CD Pipeline Failure

          **Workflow:** Offline Unit Tests
          **Run URL:** $RUN_URL
          **Branch:** $GITHUB_REF_NAME
          **Commit:** $GITHUB_SHA
          **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ### üîó Links
          - [Workflow Run]($RUN_URL)
          - [Repository](https://github.com/$GITHUB_REPOSITORY)

          ---
          ü§ñ This issue was automatically created by CI test failure.
          Please review the test output above and address the failure."

          if gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --label "ci-failure,basic"; then
            echo "‚úÖ Basic GitHub issue created successfully"
          else
            echo "‚ùå Failed to create GitHub issue"
            exit 1
          fi
        fi
