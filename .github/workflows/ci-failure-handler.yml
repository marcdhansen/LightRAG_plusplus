# Enhanced CI/CD Failure Handler - PR-Friendly
# Handles failures on both default branch and Pull Requests
# Creates diagnostic issues with proper PR context and notifications
name: CI/CD Failure Handler

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      test_failure:
        description: 'Test failure handling'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ci-failure-handler:
    name: CI/CD Failure Handler
    runs-on: ubuntu-latest
    if: github.event.inputs.test_failure == 'true' || github.event_name == 'push' || startsWith(github.event_name, 'pull_request')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: CI diagnostic and issue creation
      run: |
        echo "üîç CI/CD Failure Handler activated"
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "SHA: ${{ github.sha }}"

        # Set environment variables for diagnostic script
        export GITHUB_ACTIONS=true
        export WORKFLOW_NAME="${{ github.workflow }}"
        export RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        export GITHUB_REPOSITORY="${{ github.repository }}"
        export GITHUB_REF_NAME="${{ github.ref_name }}"
        export GITHUB_SHA="${{ github.sha }}"
        
        # Extract PR information if available
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          export PR_NUMBER="${{ github.event.number }}"
          export PR_TITLE="${{ github.event.pull_request.title }}"
          export PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          export BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          export HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
        else
          export PR_NUMBER=""
          export PR_TITLE=""
          export PR_AUTHOR=""
          export BASE_BRANCH=""
          export HEAD_BRANCH="${{ github.ref }}"
        fi

        # Test issue creation
        ./scripts/ci-diagnostic.sh || {
          echo "‚ö†Ô∏è Diagnostic script failed, creating basic issue..."
          gh issue create \
            --title "CI/CD Failure: $WORKFLOW_NAME" \
            --body "CI/CD pipeline failed on $RUN_URL" \
            --label "ci-failure,${{ github.event_name }}"
        }

        # Test issue creation
        ./scripts/ci-diagnostic.sh || {
          echo "‚ö†Ô∏è Diagnostic script failed, creating basic issue..."
          gh issue create \
            --title "Test CI failed: $WORKFLOW_NAME" \
            --body "Test workflow failure\nRun: $RUN_URL" \
            --label "ci-failure,test"
        }
