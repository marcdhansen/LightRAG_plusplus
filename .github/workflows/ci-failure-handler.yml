# Enhanced CI/CD Failure Handler
# Handles failures on other workflows and creates diagnostic issues
name: CI/CD Failure Handler

on:
  workflow_run:
    workflows:
      - "Tests"
      - "Linting"
      - "CI"
      - "Build"
      - "Test"
      - "CI Setup"
      - "TDD Compliance"
      - "Changelog Update"
      - "Dependency Audit"
      - "AB Prompt CI"
      - "Docker Build (Lite)"
      - "Docker Build (Manual)"
      - "Docker Publish"
      - "PyPI Publish"
    types: [completed]
    branches: [main]
  workflow_dispatch:  # Manual trigger for testing

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ci-failure-handler:
    name: CI/CD Failure Handler
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: Get failed workflow info
      id: workflow-info
      run: |
        echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
        echo "workflow_run_id=${{ github.event.workflow_run.run_id }}" >> $GITHUB_OUTPUT
        echo "workflow_conclusion=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
        echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
        echo "sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
        echo "run_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.run_id }}" >> $GITHUB_OUTPUT

    - name: CI failure handler
      run: |
        echo "üîç CI/CD Failure Handler activated"
        echo "Failed workflow: ${{ github.event.workflow_run.name }}"
        echo "Run URL: ${{ steps.workflow-info.outputs.run_url }}"
        echo "Branch: ${{ steps.workflow-info.outputs.branch }}"
        echo "SHA: ${{ steps.workflow-info.outputs.sha }}"

        WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
        RUN_URL="${{ steps.workflow-info.outputs.run_url }}"
        BRANCH="${{ steps.workflow-info.outputs.branch }}"
        SHA="${{ steps.workflow-info.outputs.sha }}"

        cat << 'EOF' > /tmp/issue_body.txt
        ## üö® CI/CD Pipeline Failure

        **Workflow:** $WORKFLOW_NAME
        **Run URL:** $RUN_URL
        **Branch:** $BRANCH
        **Commit:** $SHA
        **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

        ---
        ü§ñ This issue was automatically created by the CI Failure Handler.
        EOF

        # Run diagnostic script if available
        if [[ -f "./scripts/ci-diagnostic.sh" ]]; then
          export GITHUB_ACTIONS=true
          export WORKFLOW_NAME="$WORKFLOW_NAME"
          export RUN_URL="$RUN_URL"
          export GITHUB_REPOSITORY="${{ github.repository }}"
          export GITHUB_REF_NAME="$BRANCH"
          export GITHUB_SHA="$SHA"

          ./scripts/ci-diagnostic.sh || {
            echo "‚ö†Ô∏è Diagnostic script failed, creating basic issue..."
            gh issue create \
              --title "CI/CD Failure: $WORKFLOW_NAME" \
              --body-file /tmp/issue_body.txt \
              --label "ci-failure,automated"
          }
        else
          echo "üìù Creating issue for CI failure..."
          gh issue create \
            --title "CI/CD Failure: $WORKFLOW_NAME" \
            --body-file /tmp/issue_body.txt \
            --label "ci-failure,automated"
        fi

        echo "‚úÖ CI failure handler completed"
