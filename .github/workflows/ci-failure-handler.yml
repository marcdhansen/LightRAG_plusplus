# Enhanced CI/CD Failure Handler - PR-Friendly
# Handles failures on both default branch and Pull Requests
# Creates diagnostic issues with proper PR context and notifications
name: CI/CD Failure Handler

on:
  workflow_run:
    workflows: ["Offline Unit Tests", "Changelog Update", "TDD Compliance Check"]
    types: [completed]
  workflow_dispatch:  # Manual trigger for testing
    inputs:
      test_failure:
        description: 'Test failure handling'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ci-failure-handler:
    name: CI/CD Failure Handler
    runs-on: ubuntu-latest
    if: github.event.inputs.test_failure == 'true' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'

    - name: CI diagnostic and issue creation
      run: |
        echo "üîç CI/CD Failure Handler activated"
        echo "Event: ${{ github.event_name }}"
        echo "Workflow: ${{ github.event.workflow_run.name }}"
        echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
        
        # Set environment variables for diagnostic script
        export GITHUB_ACTIONS=true
        export WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
        export RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"
        export GITHUB_REPOSITORY="${{ github.repository }}"
        export GITHUB_SHA="${{ github.event.workflow_run.head_sha }}"
        export GITHUB_REF_NAME="${{ github.event.workflow_run.head_branch }}"
        
        # Extract PR information if available
        if [ "${{ github.event_name }}" = "workflow_run" ] && [ "${{ github.event.workflow_run.pull_requests }}" != "" ]; then
          # Parse pull request info from workflow_run event
          PR_NUMBER=$(echo '${{ github.event.workflow_run.pull_requests }}' | jq -r '.[0].number')
          PR_TITLE=$(echo '${{ github.event.workflow_run.pull_requests }}' | jq -r '.[0].title')
          PR_AUTHOR=$(echo '${{ github.event.workflow_run.pull_requests }}' | jq -r '.[0].user.login')
          BASE_BRANCH=$(echo '${{ github.event.workflow_run.pull_requests }}' | jq -r '.[0].base.ref')
          HEAD_BRANCH=$(echo '${{ github.event.workflow_run.pull_requests }}' | jq -r '.[0].head.ref')
          
          export PR_NUMBER="$PR_NUMBER"
          export PR_TITLE="$PR_TITLE"
          export PR_AUTHOR="$PR_AUTHOR"
          export BASE_BRANCH="$BASE_BRANCH"
          export HEAD_BRANCH="$HEAD_BRANCH"
        else
          export PR_NUMBER=""
          export PR_TITLE=""
          export PR_AUTHOR=""
          export BASE_BRANCH=""
          export HEAD_BRANCH=""
        fi

        # Run diagnostic script with proper error handling
        echo "üß™ Running CI diagnostic script..."
        if ./scripts/ci-diagnostic.sh; then
          echo "‚úÖ CI diagnostic completed successfully"
        else
          echo "‚ö†Ô∏è Diagnostic script failed, creating basic issue..."
          
          # Create basic issue with error handling
          ISSUE_BODY=$(cat <<EOF
        ## üö® CI/CD Pipeline Failure

        **Workflow**: $WORKFLOW_NAME  
        **Run URL**: $RUN_URL  
        **Branch**: $GITHUB_REF_NAME  
        **Commit**: $GITHUB_SHA  
        **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)

        ### üîó Links
        - [Workflow Run]($RUN_URL)
        - [Repository](https://github.com/$GITHUB_REPOSITORY)

        ---
        ü§ñ This issue was automatically created by CI failure handler.
        Please review the workflow logs and address the failure.
        EOF
        )

          if gh issue create \
            --title "CI/CD Failure: $WORKFLOW_NAME" \
            --body "$ISSUE_BODY" \
            --label "ci-failure,${{ github.event_name }}"; then
            echo "‚úÖ GitHub issue created successfully"
          else
            echo "‚ùå Failed to create GitHub issue"
            echo "Exit code: $?"
            exit 4
          fi
        fi